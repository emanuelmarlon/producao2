generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id           String   @id @default(uuid())
  name         String
  description  String?
  sku          String?  // SKU code
  barcode      String?  // Barcode
  supplierCode String?  @map("supplier_code") // Supplier code
  dumCode      String?  @map("dum_code") // DUM code for barcode
  type         String   // raw_material, finished, packaging, intermediate
  density      Float    @default(1.0) // g/cm3 or kg/L
  netWeight    Float    @default(0) @map("net_weight") // Standard content size (e.g. 500g, 200ml)
  unit         String   // kg, un, L
  currentCost  Float    @default(0) @map("current_cost")
  minStock     Float    @default(0) @map("min_stock")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  manufacturingMode String?  @map("manufacturing_mode")
  ph           String?
  viscosity    String?
  odor         String?
  aspect       String?
  color        String?

  formulaItems     FormulaItem[]
  productionOrders ProductionOrder[]
  stockMovements   StockMovement[]
  lots             Lot[]
  formulas         Formula[] // Formulas where this product is the output
  productionOrderItems ProductionOrderItem[]

  @@map("products")
}

model Formula {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  product     Product  @relation(fields: [productId], references: [id])
  version     String   @default("1.0")
  description String?
  status      String   // draft, approved, archived
  batchSize   Float    @default(100) @map("batch_size") // Reference size for calculation
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  items            FormulaItem[]
  productionOrders ProductionOrder[]

  @@map("formulas")
}

model FormulaItem {
  id           String  @id @default(uuid())
  formulaId    String  @map("formula_id")
  formula      Formula @relation(fields: [formulaId], references: [id])
  ingredientId String  @map("ingredient_id")
  ingredient   Product @relation(fields: [ingredientId], references: [id])
  percentage   Float   // Percentage of the total batch (0-100)
  unit         String  // kg, g, L, ml, un
  phase        Int     @default(1) // Process phase
  notes        String?

  @@map("formula_items")
}

model ProductionOrder {
  id              String    @id @default(uuid())
  code            String    @unique // Readable code e.g. OP-2023-001
  productId       String    @map("product_id")
  product         Product   @relation(fields: [productId], references: [id])
  formulaId       String    @map("formula_id")
  formula         Formula   @relation(fields: [formulaId], references: [id])
  quantityPlanned Float     @map("quantity_planned")
  quantityReal    Float?    @map("quantity_real")
  unit            String
  status          String    // draft, planned, in_progress, finished, cancelled
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  lotNumber       String?   @map("lot_number") // Generated lot for the output
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  items          ProductionOrderItem[]
  stockMovements StockMovement[]

  @@map("production_orders")
}

model ProductionOrderItem {
  id                String          @id @default(uuid())
  productionOrderId String          @map("production_order_id")
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id])
  ingredientId      String          @map("ingredient_id")
  ingredient        Product         @relation(fields: [ingredientId], references: [id])
  quantityPlanned   Float           @map("quantity_planned")
  quantityReal      Float?          @map("quantity_real")
  lotUsedId         String?         @map("lot_used_id")
  lotUsed           Lot?            @relation(fields: [lotUsedId], references: [id])

  @@map("production_order_items")
}

model Lot {
  id              String    @id @default(uuid())
  code            String    @unique
  productId       String    @map("product_id")
  product         Product   @relation(fields: [productId], references: [id])
  quantityInitial Float     @map("quantity_initial")
  quantityCurrent Float     @map("quantity_current")
  expirationDate  DateTime? @map("expiration_date")
  manufactureDate DateTime? @map("manufacture_date")
  status          String    // active, quarantined, expired, depleted
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  stockMovements       StockMovement[]
  productionOrderItems ProductionOrderItem[]

  @@map("lots")
}

model StockMovement {
  id                String           @id @default(uuid())
  productId         String           @map("product_id")
  product           Product          @relation(fields: [productId], references: [id])
  lotId             String?          @map("lot_id")
  lot               Lot?             @relation(fields: [lotId], references: [id])
  type              String           // in, out, loss, production_in, production_out
  quantity          Float
  cost              Float            @default(0)
  productionOrderId String?          @map("production_order_id")
  productionOrder   ProductionOrder? @relation(fields: [productionOrderId], references: [id])
  reference         String?          // Invoice number, etc.
  createdAt         DateTime         @default(now()) @map("created_at")

  @@map("stock_movements")
}
